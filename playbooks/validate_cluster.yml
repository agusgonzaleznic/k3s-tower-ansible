---
- name: Validate cluster connectivity
  hosts: pies
  become: true
  tasks:
    - name: Ping all nodes
      ansible.builtin.ping:

- name: Validate K3s is running on bootstrap master
  hosts: bootstrapMaster
  become: true
  tasks:
    - name: Check K3s server status
      ansible.builtin.shell: systemctl is-active k3s
      register: k3s_status
      failed_when: k3s_status.rc != 0
      changed_when: false

    - name: Ensure K3s server is active
      ansible.builtin.debug:
        msg: "K3s server is active and running."
      when: k3s_status.stdout == "active"

- name: Validate K3s is running on worker nodes
  hosts: workers
  become: true
  tasks:
    - name: Check K3s agent status
      ansible.builtin.shell: systemctl is-active k3s-agent
      register: k3s_agent_status
      failed_when: k3s_agent_status.rc != 0
      changed_when: false

    - name: Ensure K3s agent is active
      ansible.builtin.debug:
        msg: "K3s agent is active and running."
      when: k3s_agent_status.stdout == "active"
